# Docker Test Harness

[Command Cheat Sheet](#command-cheat-sheet) · [Overview](#overview) · [Requirements](#requirements) · [Configuration](#configuration) · [Workflow](#workflow) · [CI Guide](CI.md) · [Directory Layout](#directory-layout) · [Troubleshooting-and-legacy-docs](#troubleshooting-and-legacy-docs)

## Command Cheat Sheet

All commands are run from the repository root.

```bash
# Build images and run every configured suite on every platform
./docker-tests/scripts/run-tests.sh

# Limit to specific platforms or architectures
./docker-tests/scripts/run-tests.sh --platforms linux,alpine --architectures amd64

# Execute a focused suite
./docker-tests/scripts/run-tests.sh --test-suites basic,protocols

# Increase verbosity and keep intermediate artefacts for inspection
./docker-tests/scripts/run-tests.sh --verbose --keep-artifacts

# Dry-run to inspect the plan without launching containers
./docker-tests/scripts/run-tests.sh --dry-run

# Clean cached images, containers, and artefacts generated by previous runs
./docker-tests/scripts/run-tests.sh --clean
```

## Overview

The Docker Test Harness exercises Zigcat builds across multiple operating systems and CPU architectures using Docker and Docker Compose. It compiles Zigcat for each requested target, executes the selected test suites inside disposable containers, and publishes consolidated results that can feed local workflows or CI pipelines.

Key capabilities:
- Multi-platform coverage: Ubuntu (glibc), Alpine (musl), and FreeBSD.
- Multi-architecture builds: amd64 and arm64 via Docker Buildx.
- Automated execution of functional, protocol, and performance suites.
- Reproducible environment setup with a single entry-point script.

## Requirements

- Docker Engine 20.10 or newer with the Compose plugin (`docker compose version`).
- Docker Buildx enabled for multi-architecture builds (`docker buildx ls`).
- 8 GB RAM and 4 GB free disk space recommended for parallel workloads.
- Bash-compatible shell (the harness scripts target POSIX sh but use Bash extensions for option parsing).

Optional tooling:
- GNU Make (used by some CI examples for orchestration).
- `jq` for inspecting JSON result summaries.

## Configuration

The default configuration lives in `docker-tests/configs/test-config.yml`. It declares:
- `platforms`: container images and supported architectures.
- `test_suites`: named groups of tests with individual timeouts.
- `timeouts`: global execution guards for build, test, and cleanup phases.

Override behaviour by supplying `--config /path/to/file.yml` or by creating small overlay files that `run-tests.sh` can merge via the `--config` flag. Example overlays are stored under `docker-tests/configs/examples/` (minimal smoke tests, CI profiles, performance stress runs).

Environment variables recognised by the harness:
- `ZIGCAT_BUILD_OPTS`: extra flags appended to `zig build` invocations.
- `DOCKER_TESTS_PARALLEL=1`: enable parallel container scheduling when host resources allow.
- `DOCKER_TESTS_LOG_LEVEL`: override the default log level (`info`, `debug`, `trace`).

## Workflow

1. **Plan** – `run-tests.sh` parses CLI options, loads configuration, and expands the matrix of platform × architecture × suite combinations.
2. **Build** – Docker Buildx compiles Zigcat for each target. Artefacts are stored under `docker-tests/artifacts/`.
3. **Execute** – Docker Compose launches container stacks, mounts artefacts, and runs the requested suites. Raw logs stream to the console and to `docker-tests/logs/`.
4. **Collect** – Structured results land in `docker-tests/results/` (JSON summaries plus human-readable reports). Exit codes are derived from aggregated suite status.
5. **Cleanup** – Unless `--keep-artifacts` is set, containers and temporary images are removed. `--clean` performs an explicit purge.

## CI / CD

Refer to `docker-tests/CI.md` for automation workflows, sample pipeline configurations, and guidance on handling logs and artefacts in continuous integration environments.

## Directory Layout

```
docker-tests/
├── configs/                # YAML configurations (default + examples)
├── dockerfiles/            # Per-platform Dockerfiles
├── scripts/                # run-tests.sh and helpers
├── artifacts/              # Build outputs (created on demand)
├── logs/                   # Execution logs (created on demand)
└── results/                # Structured result summaries (created on demand)
```

Legacy guidance, extended platform notes, and historical validation reports now reside under `docs-archive/docker-tests/`.

## Troubleshooting and Legacy Docs

- Inspect `docker-tests/logs/<timestamp>/compose.log` for container-level errors.
- Check JSON reports in `docker-tests/results/` to identify failing suites and platforms.
- Remove cached layers with `./docker-tests/scripts/run-tests.sh --clean` if builds become inconsistent.
- Refer to archived material under `docs-archive/docker-tests/` for deep dives on configuration details, platform nuances, and previous validation summaries.

For unresolved issues, capture the failing command with `--verbose`, attach the relevant log bundle, and file an issue with the configuration file and host environment details.
